<html>
	<head>

		<style type="text/css">
			canvas {
			    margin: 1em;
			    border: 1px solid #dddddd;
		    }
	    </style>


		<script type="text/javascript">
		var filesatwork = new Array();
		var files = new Array();
		files.push({zerofill1:""});
		filesatwork.push({zerofill2:""});
		black = {
		    r: 0,
		    g: 0,
		    b: 0,
		    a: 255
		};

		function Open_control(){
		
			ws = new WebSocket("ws://10.241.26.30:80/websocket");
			ws.onopen = function(){
				console.log('Control connected');
			};
			ni = document.getElementById('files_table');
			// element = document.getElementById("canvas2");
			// canvas = element.getContext("2d");

			// var setPixel = function (x,y,c) {
		 //    var p=canvas.createImageData(1,1);
		 //    p.data[0]=c.r;
		 //    p.data[1]=c.g;
		 //    p.data[2]=c.b;
		 //    p.data[3]=c.a;
		 //    canvas.putImageData(p,x,y);
		 //    canvas.putImageData(p,x,y+1);
		 //    canvas.putImageData(p,x,y+2);
		 //    canvas.putImageData(p,x,y+3);
		 //    canvas.putImageData(p,x,y+4);
		 //    canvas.putImageData(p,x,y+5);
		 //    canvas.putImageData(p,x,y+6);
		 //    canvas.putImageData(p,x,y+7);

			// }

			ws.onmessage = function (evt)
			{
				// var received_msg = evt.data;
				// setPixel(1, 1, black);
				
				switch (evt.data.slice(0,7))
				{
					case "newfile": 
						Name = evt.data.slice(9,evt.data.length-37);
						FileSize = evt.data.slice(evt.data.length-33,evt.data.length-21);
						ChunkSize = evt.data.slice(evt.data.length-15,evt.data.length-3);
						Num = files.push({name:Name,filesize:FileSize,canvas:"",tr:"",td1:"",td2:"",td3:"",td4:"",td5:"",chunk:""}) - 1;
						console.log('Recv NewFile ' + Name + ' FileNum ' + Num + ' filesize ' + FileSize + ' chunksize ' + ChunkSize + ' Chunks ' + Math.ceil(FileSize/ChunkSize));
						filesatwork.push({num:Num,name:Name});
						files[Num].name = Name;
						files[Num] = new Array();
						files[Num][files[Num].push()] = {name:Name,filesize:FileSize,canvas:"",tr:"",td1:"",td2:"",td3:"",td4:"",td5:"",chunk:""};
						// Create table cell
						files[Num][0].tr = document.createElement('tr');
						files[Num][0].td1 = document.createElement('td');
						files[Num][0].td1.innerHTML = Num;
						files[Num][0].td2 = document.createElement('td');
						files[Num][0].td3 = document.createElement('td');
						files[Num][0].td3.innerHTML = "0";
						files[Num][0].td4 = document.createElement('td');
						files[Num][0].td4.innerHTML = FileSize;
						files[Num][0].td5 = document.createElement('td');
						files[Num][0].td5.innerHTML = Name;
						ni.appendChild(files[Num][0].tr);
						files[Num][0].tr.appendChild(files[Num][0].td1);
						files[Num][0].tr.appendChild(files[Num][0].td2);
						files[Num][0].tr.appendChild(files[Num][0].td3);
						files[Num][0].tr.appendChild(files[Num][0].td4);
						files[Num][0].tr.appendChild(files[Num][0].td5);

						// console.log(files[Num][0]);
						PutCanvas(Num);
						break;
					case "newchnk": 
						File = evt.data.slice(15,evt.data.length-1);
						Thread = evt.data.slice(8,9);
						// console.log('Recv NewChunk ' + File + ' AND '+Thread);
						for(var i=1; i<filesatwork.length; i++) {
					        if (filesatwork[i].name == File) {
								// console.log('Found ONE ' + i);
								Open_Data(filesatwork[i].num,Thread);
					        };
					    }
						break;
					case "donechk": 
						console.log('Recv DoneChunk ' + evt.data );
						DoneChunkFile =  evt.data.slice(15,evt.data.length-1);
						DoneChunkSeq = evt.data.slice(8,9);
						// console.log('ONE ' + filesatwork[i].name + 'ONE ' + DoneChunkFile);
						
						for(var i=1; i<filesatwork.length; i++) {
							// console.log(filesatwork[i]);
					        if (filesatwork[i].name == DoneChunkFile) {
								files[filesatwork[i].num][DoneChunkSeq].ws.close();
								console.log('Found ONE ' + DoneChunkSeq + '-' + files[filesatwork[i].num][DoneChunkSeq].recv);
								// Open_Data(filesatwork[i].num,Thread);
					        };
					    }
					    break;
				default: console.log('CtrlMSG ' + evt.data);;
				}
			};
			ws.onclose = function()
			{
				console.log('Connection closed');
			};
		}

		function SendMsg()
		{
			var Msg = document.getElementById('txt').value;
			ws.send(Msg);
			console.log('Sent: ', Msg);
		}


		function Open_Data(Num,Thread){
			ChunkSeq = files[Num].push();
			files[Num][ChunkSeq] = {ws:"",recv:""};
			console.log('OpenChunk-' + Num +'-'+ Thread +'-'+ChunkSeq);
			files[Num][ChunkSeq].recv = 0;
			files[Num][ChunkSeq].ws.chunk = ChunkSeq;
			files[Num][ChunkSeq].ws = new WebSocket("ws://10.241.26.30:80/websocket" + Thread);
			files[Num][ChunkSeq].ws.onopen = function(){
				// files[1].ws.send(1);
				// console.log('Data Connected - ' + Thread);
			};
			//ChunkSeq - глобальная изменяющаяся переменная
			//ws - вебсокет
			var onmessage = {a:ChunkSeq,fun:function(event) {console.log('Check--' + this.a + "--" +event.data);}};
			files[Num][ChunkSeq].ws.addEventListener("message", function(event) {
			  onmessage.fun(event);
			});
			// files[Num][ChunkSeq].ws.onmessage = function (evt)
			// {
			// 	console.log(this)
			// 	var C1 = ChunkSeq;
			// 	files[Num][ChunkSeq].recv = evt.data;
			// 	console.log('Beg');
			// 	console.log('DataMSG__TRUE --' + evt.data.charAt(0));
			// 	console.log('DataMSG_FALSE --' + C1);
			// 	console.log('Eng');
			// 	// if (ChunkSeq == 0) {

			// 	// 	SetPixel(files[Num][0].canvas,parseInt(evt.data/16777));
			// 	// 	console.log('DataMSG ' + evt.data);
			// 	// }
				
			// 	// console.log('DataMSG ' + files[Num][ChunkSeq].packets);
			// };
			files[Num][ChunkSeq].ws.onclose = function()
			{
				console.log('Data Connection for file ' + Num +' chunk ' + ChunkSeq + ' closed');
			};
		};


		function Close2(evt,a) {

			console.log('D' + a);
		}

		function Close() {
			ws.close();
		}

		function PutCanvas(Id){ 
			// div = document.getElementById("bar"+(Id-1));
			files[Id][0].canvas = document.createElement('canvas');
			files[Id][0].canvas.setAttribute('id','bar'+Id);
			files[Id][0].canvas.setAttribute('width','700');
			files[Id][0].canvas.setAttribute('height','10');
			// div.appendChild(files[Id][0]);
			files[Id][0].td2.appendChild(files[Id][0].canvas);
			var element,
			    canvas,
			    width,
			    height,
			    red;



			// init canvas
			element = document.getElementById('bar'+Id);
			canvas = element.getContext("2d");


			width = element.width;
			height = element.height;
			canvas.fillStyle = '#eeeeee';
			canvas.fillRect(0, 0, width, height);

			
			// setpixel
			// var setPixel = function (x,y,c) {
			//     var p=canvas.createImageData(1,1);
			//     p.data[0]=c.r;
			//     p.data[1]=c.g;
			//     p.data[2]=c.b;
			//     p.data[3]=c.a;
			//     canvas.putImageData(p,x,y);
			//     canvas.putImageData(p,x,y+1);
			//     canvas.putImageData(p,x,y+2);
			//     canvas.putImageData(p,x,y+3);
			//     canvas.putImageData(p,x,y+4);
			//     canvas.putImageData(p,x,y+5);
			//     canvas.putImageData(p,x,y+6);
			//     canvas.putImageData(p,x,y+7);
			// }

			
			// console.log(files[Id][0]);

			// element.onclick = function (e) { setPixel(e.offsetX, e.offsetY, black);};
		}

		function SetPixel(canvas,x){
				// console.log('X:' + x);
				var ctx=canvas.getContext("2d");
			    var p=ctx.createImageData(1,1);
			    p.data[0]=black.r;
			    p.data[1]=black.g;
			    p.data[2]=black.b;
			    p.data[3]=black.a;
			    ctx.putImageData(p,x,1);
			    ctx.putImageData(p,x,2);
			    ctx.putImageData(p,x,3);
			    ctx.putImageData(p,x,4);
			    ctx.putImageData(p,x,5);
			    ctx.putImageData(p,x,6);
			    ctx.putImageData(p,x,7);
		} 

		</script>
	</head>
	<body>
		<div id="menu1">
			<a href="javascript:Open_control()">Open control websocket connection</a>
			<a href="javascript:Close()">Close control websocket connection</a>
			<a href="javascript:SendMsg()">SendMsg</a>
		</div>
		<input type="text" id="txt" size="120" value="1" ></input>
		
		<div id="menu2">
			<a href="javascript:Open_telnet()">Open telnet 0.116</a>
		</div>
	<!--	
		<div id="msgs"></div>
		<input id="count" type="text" value="0"></input>
		<progress id="progressBar" value="0" max="100"></progress><br>
		<div id="files_div"><br></div>
		<textarea style="resize:none;width:130px;font-family:Consolas;vertical-align:top;height:40px;overflow:hidden;">1234567/1234567</textarea><br><br>
	-->
<table id="files_table" style="border-style:ridge;border-collapse:collapse;font-family:Consolas;font-size:12px;" cellspacing="0" border="0" cellpadding="1" height="1" width="1024">

<tr id="tr_basic">
<td id="td1">0</td>
<td id="td2"><progress id="progressBar" value="0" max="100"></progress></td>
<td id="td3">Sent</td>
<td id="td4">/ End</td>
<td id="td5">FileName</td>
</tr>

</table>

<div id="bar0"></div>
	</body>
</html>